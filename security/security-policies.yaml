# Security Policies Configuration for Superego MCP
# Comprehensive security rules and policies for production deployment

# Network security policies
network_security:
  # Ingress rules
  ingress:
    allowed_ports:
      - 8000  # Main application port
      - 8001  # Metrics port (internal only)
    
    # Source IP restrictions
    ip_allowlist:
      enabled: true
      default_action: "deny"
      allowed_ranges:
        - "10.0.0.0/8"     # Private network
        - "172.16.0.0/12"  # Docker networks
        - "192.168.0.0/16" # Local networks
        # Add your specific IP ranges here
    
    # Geographic restrictions
    geo_restrictions:
      enabled: false  # Enable if needed
      allowed_countries: []  # ISO country codes
      blocked_countries: []  # ISO country codes
  
  # Egress rules
  egress:
    # AI service endpoints
    ai_services:
      anthropic:
        - "api.anthropic.com:443"
      openai:
        - "api.openai.com:443"
    
    # Monitoring and logging
    monitoring:
      - "prometheus:9090"
      - "grafana:3000"
      - "loki:3100"
    
    # DNS and time services
    system:
      - "1.1.1.1:53"     # Cloudflare DNS
      - "8.8.8.8:53"     # Google DNS
      - "pool.ntp.org:123"  # NTP time sync

# Authentication and authorization
auth_security:
  # API key policies
  api_keys:
    # Key strength requirements
    strength:
      min_length: 32
      require_uppercase: true
      require_lowercase: true  
      require_numbers: true
      require_special_chars: true
      entropy_threshold: 4.0
    
    # Key rotation policy
    rotation:
      max_age_days: 90
      warning_before_expiry_days: 7
      auto_rotation_enabled: false
    
    # Key usage monitoring
    monitoring:
      track_usage: true
      alert_on_unusual_patterns: true
      max_requests_per_hour: 1000
      max_failed_attempts: 10
  
  # Session management
  sessions:
    timeout: 3600  # 1 hour
    max_concurrent: 5
    secure_cookies: true
    httponly_cookies: true
    samesite: "Strict"

# Input validation and sanitization
input_security:
  # Request validation
  request_validation:
    enabled: true
    
    # Size limits
    max_request_size: 1048576  # 1MB
    max_header_size: 8192      # 8KB
    max_url_length: 2048       # 2KB
    
    # Content type validation
    allowed_content_types:
      - "application/json"
      - "application/x-www-form-urlencoded"
      - "multipart/form-data"
    
    # Character encoding
    allowed_encodings:
      - "utf-8"
      - "ascii"
  
  # Content filtering
  content_filtering:
    enabled: true
    
    # Blocked patterns (regex)
    blocked_patterns:
      # SQL injection patterns
      - "(?i)(union|select|insert|update|delete|drop|create|alter)\\s"
      - "(?i)(script|javascript|vbscript|onload|onerror)"
      
      # Command injection patterns  
      - "(?i)(\\||&|;|`|\\$\\(|\\${)"
      
      # Path traversal
      - "\\.\\./|\\.\\.\\\\"
      
      # Sensitive data patterns
      - "(?i)(password|passwd|secret|api_key|token)\\s*[:=]"
    
    # Sanitization rules
    sanitization:
      html_encode: true
      remove_null_bytes: true
      normalize_unicode: true
      trim_whitespace: true

# Rate limiting and DDoS protection
rate_limiting:
  # Global rate limits
  global:
    requests_per_second: 10
    requests_per_minute: 100
    requests_per_hour: 1000
    concurrent_connections: 50
  
  # Per-endpoint rate limits
  endpoints:
    "/health":
      requests_per_minute: 300
      burst: 10
    
    "/metrics":
      requests_per_minute: 60
      burst: 5
    
    "/advise":
      requests_per_minute: 30
      burst: 3
      # Special handling for AI endpoints
      ai_rate_limit: true
      ai_requests_per_minute: 20
  
  # Per-client rate limits
  per_client:
    requests_per_minute: 60
    burst: 10
    
    # Sliding window configuration
    window_size: 60  # seconds
    precision: 10    # sub-windows
  
  # DDoS protection
  ddos_protection:
    enabled: true
    
    # Thresholds for automatic blocking
    auto_block:
      requests_per_second: 50
      block_duration: 300  # 5 minutes
      escalation_factor: 2  # Double block time on repeat offenses
    
    # Rate limiting algorithms
    algorithm: "sliding_window"  # or "token_bucket", "fixed_window"

# Data protection and privacy
data_security:
  # Data classification
  classification:
    public: ["health", "metrics", "version"]
    internal: ["logs", "audit", "performance"]
    confidential: ["api_keys", "user_data", "ai_responses"]
    restricted: ["secrets", "credentials", "private_keys"]
  
  # Data encryption
  encryption:
    # Encryption at rest
    at_rest:
      enabled: true
      algorithm: "AES-256-GCM"
      key_rotation: true
    
    # Encryption in transit
    in_transit:
      tls_version: "1.2"  # Minimum TLS version
      cipher_suites:
        - "ECDHE-RSA-AES256-GCM-SHA384"
        - "ECDHE-RSA-AES128-GCM-SHA256"
        - "ECDHE-RSA-AES256-SHA384"
        - "ECDHE-RSA-AES128-SHA256"
  
  # Data retention
  retention:
    # Default retention periods
    default_retention_days: 30
    
    # Per-data-type retention
    policies:
      audit_logs: 90     # days
      access_logs: 30    # days
      performance_data: 7  # days
      error_logs: 60     # days
      ai_interactions: 7  # days (minimal retention for AI data)
  
  # Data masking
  masking:
    enabled: true
    patterns:
      # API keys and tokens
      api_key: "sk-****...****"
      token: "****...****"
      
      # Personal information
      email: "*****@****.***"
      phone: "***-***-****"
      
      # Financial data
      credit_card: "****-****-****-1234"

# Security monitoring and alerting
security_monitoring:
  # Event monitoring
  events:
    # Security events to monitor
    monitored_events:
      - authentication_failure
      - authorization_failure
      - rate_limit_exceeded
      - suspicious_request_pattern
      - configuration_change
      - service_start_stop
      - error_rate_spike
    
    # Alert thresholds
    thresholds:
      failed_auth_attempts: 10      # per hour
      rate_limit_violations: 20     # per hour
      error_rate: 0.05             # 5% error rate
      response_time_p99: 5000      # 5 seconds
  
  # Anomaly detection
  anomaly_detection:
    enabled: true
    
    # Baseline metrics
    baseline_period: 168  # hours (1 week)
    sensitivity: 2.0      # standard deviations
    
    # Monitored metrics
    metrics:
      - request_rate
      - error_rate
      - response_time
      - geographic_distribution
      - user_agent_patterns
  
  # Incident response
  incident_response:
    # Automatic responses
    auto_response:
      enabled: true
      
      # Response actions
      actions:
        block_ip: true
        rate_limit_client: true
        scale_resources: false  # Manual scaling in production
        notify_admins: true
    
    # Manual response procedures
    escalation:
      level1_threshold: 10   # minor incidents per hour
      level2_threshold: 50   # major incidents per hour  
      level3_threshold: 100  # critical incidents per hour

# Compliance and audit
compliance:
  # Audit requirements
  audit:
    enabled: true
    
    # Audit events
    events:
      - all_api_calls
      - authentication_events
      - authorization_events
      - configuration_changes
      - data_access
      - administrative_actions
    
    # Audit data integrity
    integrity:
      enabled: true
      checksum_algorithm: "SHA-256"
      tamper_detection: true
    
    # Retention and archival
    retention:
      audit_logs: 365  # days (1 year minimum)
      archive_after: 90  # days
      compression: true
  
  # Regulatory compliance
  regulations:
    # GDPR compliance (if handling EU data)
    gdpr:
      enabled: false
      data_minimization: true
      consent_tracking: true
      right_to_erasure: true
    
    # SOC2 compliance
    soc2:
      enabled: true
      access_controls: true
      system_monitoring: true
      change_management: true
    
    # ISO 27001 compliance
    iso27001:
      enabled: false
      risk_assessment: true
      security_controls: true
      continuous_monitoring: true

# Container and infrastructure security
container_security:
  # Container runtime security
  runtime:
    # User and privilege management
    non_root_user: true
    read_only_filesystem: true
    no_new_privileges: true
    
    # Capabilities
    dropped_capabilities: ["ALL"]
    added_capabilities: ["NET_BIND_SERVICE", "SETGID", "SETUID"]
    
    # Security profiles
    apparmor_profile: "docker-default"
    seccomp_profile: "runtime/default"
  
  # Image security
  image:
    # Base image requirements
    base_image: "python:3.12-slim"  # Minimal base image
    scan_required: true
    vulnerability_threshold: "HIGH"  # Block deployment on HIGH+ vulnerabilities
    
    # Image signing and verification
    signature_verification: true
    trusted_registries: ["ghcr.io"]
  
  # Network security
  network:
    # Network policies
    network_policies: true
    deny_all_default: true
    
    # Service mesh (if applicable)
    service_mesh:
      enabled: false
      mtls_required: true

# Secrets management
secrets_management:
  # Secret storage
  storage:
    provider: "kubernetes_secrets"  # or "vault", "aws_secrets_manager"
    encryption: true
    access_control: true
  
  # Secret rotation
  rotation:
    enabled: true
    
    # Rotation schedules
    schedules:
      api_keys: 90      # days
      certificates: 365  # days
      database_passwords: 30  # days
  
  # Secret access
  access:
    # Just-in-time access
    jit_access: true
    approval_required: true
    
    # Access logging
    log_access: true
    alert_on_access: true

# Backup and disaster recovery
backup_security:
  # Backup encryption
  encryption:
    enabled: true
    algorithm: "AES-256"
    key_management: "external"
  
  # Backup integrity
  integrity:
    checksum_verification: true
    regular_restore_tests: true
  
  # Access controls
  access:
    role_based_access: true
    multi_person_authorization: true
    audit_all_access: true